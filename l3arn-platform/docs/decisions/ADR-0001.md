# ADR-0001: Foundation Architecture Decisions

**Status:** Accepted  
**Date:** 2026-02-15  
**Context:** Establishing the foundational architecture for the L3ARN platform.

## Decisions

### 1. Single Supabase Project for Multi-Tenancy

**Decision:** Use ONE Supabase project with `tenant_id` column + RLS rather than separate projects per tenant.

**Rationale:**
- Simpler infrastructure management
- Single connection pool / auth config
- RLS provides row-level isolation at the DB layer
- Can shard later if scale demands it

**Risk:** A misconfigured RLS policy could leak data between tenants. Mitigated by `security/rls-checklist.md` and CI checks.

### 2. JWT Verification in FastAPI (not Edge Functions)

**Decision:** FastAPI verifies Supabase JWTs directly using JWKS endpoint with caching.

**Rationale:**
- Edge Functions are kept thin (intake/proxy only)
- FastAPI has full control over token parsing and custom claims
- JWKS caching reduces latency

### 3. Capabilities Registry Pattern

**Decision:** Tools self-register in a central registry (`registry.py`) with JSON contracts.

**Rationale:**
- Adding capabilities = adding files, not reorganizing folders
- Contracts are machine-readable (enables contract testing, docs generation)
- Registry provides discovery and validation at runtime

### 4. Contract-First with Dual Schemas

**Decision:** DTOs are defined in both TypeScript (zod) and Python (Pydantic). CI validates they stay in sync.

**Rationale:**
- Each language gets native, idiomatic schemas
- Zod for frontend validation, Pydantic for API validation
- Contract tests catch drift early

### 5. Docker Compose for Local Parity

**Decision:** Full docker-compose stack that mirrors production topology.

**Rationale:**
- Developers can run the entire platform with `docker compose up`
- Eliminates "works on my machine" issues
- Supabase local dev via official containers

### 6. Audit Everything

**Decision:** Every tool execution produces an audit log entry with `trace_id` and `request_id`.

**Rationale:**
- Required by the platform's core principle of auditability
- Enables debugging, compliance reporting, and trust building with parents
- `trace_id` flows from middleware → tool → audit log for full traceability
