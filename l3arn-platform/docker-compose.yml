# ============================================================
#  L3ARN Platform — Local Development Stack
# ============================================================
# Usage:
#   docker compose up -d          # start all services
#   docker compose logs -f api    # tail API logs
#   docker compose down -v        # tear down + remove volumes
# ============================================================

services:
  # ── Supabase (all-in-one via supabase/postgres) ───────────
  supabase-db:
    image: supabase/postgres:15.6.1.120
    container_name: l3arn-supabase-db
    ports:
      - "54322:5432"
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    volumes:
      - supabase-db-data:/var/lib/postgresql/data
      - ./supabase/migrations:/docker-entrypoint-initdb.d/migrations
      - ./supabase/seed:/docker-entrypoint-initdb.d/seed
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  supabase-auth:
    image: supabase/gotrue:v2.158.1
    container_name: l3arn-supabase-auth
    depends_on:
      supabase-db:
        condition: service_healthy
    ports:
      - "54321:9999"
    environment:
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      API_EXTERNAL_URL: http://localhost:54321
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: postgres://postgres:postgres@supabase-db:5432/postgres?sslmode=disable
      GOTRUE_SITE_URL: http://localhost:5173
      GOTRUE_URI_ALLOW_LIST: ""
      GOTRUE_JWT_SECRET: ${SUPABASE_JWT_SECRET:-super-secret-jwt-token-for-local-dev-only}
      GOTRUE_JWT_EXP: 3600
      GOTRUE_DISABLE_SIGNUP: "false"
      GOTRUE_EXTERNAL_EMAIL_ENABLED: "true"
      GOTRUE_MAILER_AUTOCONFIRM: "true"

  # ── FastAPI Backend ────────────────────────────────────────
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: l3arn-api
    ports:
      - "8000:8000"
    volumes:
      - ./apps/api:/app
    environment:
      API_ENV: development
      API_HOST: 0.0.0.0
      API_PORT: 8000
      API_LOG_LEVEL: debug
      API_CORS_ORIGINS: "http://localhost:5173,http://localhost:3000"
      SUPABASE_URL: http://supabase-auth:9999
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-placeholder-anon-key}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-placeholder-service-role-key}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET:-super-secret-jwt-token-for-local-dev-only}
      SUPABASE_JWKS_URL: http://supabase-auth:9999/auth/v1/.well-known/jwks.json
      DATABASE_URL: postgresql://postgres:postgres@supabase-db:5432/postgres
    depends_on:
      supabase-db:
        condition: service_healthy

  # ── Frontend (Vite dev server) ─────────────────────────────
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: l3arn-web
    ports:
      - "5173:5173"
    volumes:
      - ./apps/web:/app
      - /app/node_modules
    environment:
      VITE_SUPABASE_URL: http://localhost:54321
      VITE_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-placeholder-anon-key}
      VITE_API_BASE_URL: http://localhost:8000
    depends_on:
      - api

volumes:
  supabase-db-data:
    driver: local
